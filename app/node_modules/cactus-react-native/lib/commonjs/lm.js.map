{"version":3,"names":["_index","require","_telemetry","_remote","_chat","CactusLM","_initCache","Map","getCacheKey","params","cactusToken","retryOptions","JSON","stringify","constructor","context","initParams","conversationHistoryManager","ConversationHistoryManager","isContextNotFoundError","e","message","String","test","reinit","newContext","initLlama","reset","run","op","init","onProgress","setCactusToken","key","has","get","initPromise","maxRetries","delayMs","configs","n_gpu_layers","sleep","ms","Promise","resolve","start","Date","now","wait","then","config","lastError","attempt","lm","error","isLastConfig","indexOf","length","isLastAttempt","Telemetry","n_ctx","model","delay","Math","pow","Error","set","result","delete","completion","messages","callback","mode","_handleRemoteCompletion","_handleLocalCompletion","remoteError","localError","newMessages","requiresReset","processNewMessages","rewind","console","warn","update","role","content","prompt","map","m","join","responseText","getTextCompletion","i","token","text","reasoning_content","tool_calls","tokens_predicted","split","tokens_evaluated","truncated","stopped_eos","stopped_word","stopped_limit","stopping_word","tokens_cached","timings","prompt_n","prompt_ms","prompt_per_token_ms","prompt_per_second","predicted_n","predicted_ms","predicted_per_token_ms","predicted_per_second","embedding","_handleRemoteEmbedding","_handleLocalEmbedding","embeddingValues","getVertexAIEmbedding","release","stopCompletion","isJinjaSupported","exports"],"sourceRoot":"../../src","sources":["lm.ts"],"mappings":"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","ignoreList":[]}
