{"version":3,"names":["initLlama","Telemetry","setCactusToken","getVertexAIEmbedding","getTextCompletion","ConversationHistoryManager","CactusLM","_initCache","Map","getCacheKey","params","cactusToken","retryOptions","JSON","stringify","constructor","context","initParams","conversationHistoryManager","isContextNotFoundError","e","message","String","test","reinit","newContext","reset","run","op","init","onProgress","key","has","get","initPromise","maxRetries","delayMs","configs","n_gpu_layers","sleep","ms","Promise","resolve","start","Date","now","wait","then","config","lastError","attempt","lm","error","isLastConfig","indexOf","length","isLastAttempt","n_ctx","model","delay","Math","pow","Error","set","result","delete","completion","messages","callback","mode","_handleRemoteCompletion","_handleLocalCompletion","remoteError","localError","newMessages","requiresReset","processNewMessages","rewind","console","warn","update","role","content","prompt","map","m","join","responseText","i","token","text","reasoning_content","tool_calls","tokens_predicted","split","tokens_evaluated","truncated","stopped_eos","stopped_word","stopped_limit","stopping_word","tokens_cached","timings","prompt_n","prompt_ms","prompt_per_token_ms","prompt_per_second","predicted_n","predicted_ms","predicted_per_token_ms","predicted_per_second","embedding","_handleRemoteEmbedding","_handleLocalEmbedding","embeddingValues","release","stopCompletion","isJinjaSupported"],"sourceRoot":"../../src","sources":["lm.ts"],"mappings":"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","ignoreList":[]}
